pico-8 cartridge // http://www.pico-8.com
version 14
__lua__
-- pico-8 3d engine
-- alex bowen

-- a good chunk of the math and algorithms here
-- actually came from scratchpixel 2.0, which
-- managed to be among the top search results for
-- every specific problem i ran across and wound
-- up being a great resource. link:
-- https://www.scratchapixel.com/index.php?redirect

function _init()
    -- settings
    g_wireframe = false
    g_filled = true
    -- end settings

    --constants
    c_screen_height = 128
    c_screen_width = 128
    --end constants

    g_asset_library = parse_asset_library("pyramid,5,6,-5,-5,0,-5,5,0,5,5,0,5,-5,0.1,0,0,10,1,5,2,10,2,5,3,11,3,5,4,12,4,5,1,13,1,2,3,14,3,4,1,15,-1,0,0,0,1,0,1,0,0,0,-1,0,0,0,-1,0,0,-1,cube,8,12,-5,-5,0,-5,5,0,5,5,0,5,-5,0,-5,-5,10,-5,5,10,5,5,10,5,-5,10,1,2,3,1,3,4,1,2,5,6,7,3,7,8,5,4,5,8,1,5,4,1,8,6,6,5,1,7,1,2,6,8,2,3,7,9,7,6,2,10,3,4,8,11,8,7,3,12,0,0,-1,0,0,-1,0,0,1,0,0,1,0,-1,0,0,-1,0,-1,0,0,-1,0,0,0,1,0,0,1,0,1,0,0,1,0,0,BMesh,119,204,5.523,-3.133,10.217,-5.414,-3.133,10.217,-3.434,-3.614,9.271,3.543,-3.614,9.271,2.489,-5.443,11.503,1.617,-3.836,10.217,-1.508,-3.836,10.217,-0.606,-3.992,12.081,0.711,-3.995,12.085,3.017,-5.403,13.315,1.617,-3.836,14.045,-1.508,-3.836,14.045,3.57,-3.524,14.826,-3.461,-3.524,14.826,-2.883,-5.404,13.305,-4.612,-5.034,12.761,5.523,-3.133,14.045,-5.414,-3.133,14.045,6.388,-3.017,12.091,-6.278,-3.017,12.09,4.725,-5.033,12.754,-2.377,-5.448,11.502,4.171,-5.299,10.968,-4.062,-5.299,10.968,0.054,-5.321,7.795,-1.816,7.637,18.988,1.673,11.51,13.926,1.8,6.859,6.08,2.285,-2.727,7.844,-3.513,-3.087,0.39,3.619,-3.102,0.436,5.666,-3.043,8.836,8.069,-3.672,13.685,-2.729,-4.968,13.702,3.123,-4.88,14.437,-0.605,-4.669,2.008,0.054,-4.852,7.717,0.054,-4.774,8.264,0.914,-5.401,8.369,-5.851,-3.178,9.085,-8.112,-3.746,13.57,-2.428,-5.898,16.158,2.584,-5.859,16.232,0.01,-5.449,13.388,-0.859,-5.276,8.487,-0.257,-4.207,0.461,1.397,-4.868,7.243,0.019,-4.977,6.345,-1.228,-4.943,7.243,1.093,-4.399,1.924,-0.716,-3.669,1.365,-4.075,-4.877,13.555,-5.426,-4.17,12.688,-5.377,-4.184,11.797,-4.086,-4.541,10.548,2.036,-4.956,12.711,-1.906,-4.963,12.616,3.299,-5.42,13.575,2.283,-4.918,10.993,4.2,-4.325,10.362,5.418,-4.23,11.642,5.549,-4.107,12.704,-2.141,-4.89,10.981,0.03,-3.674,13.979,-2.457,-4.376,17.392,2.561,-4.369,17.392,-4.52,-2.099,14.956,-7.062,-0.425,13.678,-7.984,-1.552,11.285,-2.323,-2.427,7.492,7.908,-1.531,10.863,0.072,0.74,19.435,-0.062,10.441,8.918,-7.904,1.067,10.08,-8.263,6.522,13.173,-4.854,9.559,13.848,8.197,0.873,10.319,-2.086,-0.771,5.568,-2.813,-1.36,0.183,3.266,-1.439,0.564,0.057,-0.423,4.717,2.052,-0.327,5.688,4.586,6.476,18.342,-4.706,1.36,18.661,4.711,1.126,18.68,4.657,-2.078,14.943,7.229,-0.479,13.705,-7.76,1.689,15.431,7.869,1.689,15.431,7.763,6.072,15.902,-7.687,6.107,15.856,-4.067,7.349,8.118,5.45,4.233,8.241,-6.319,3.941,8.354,-12.477,7.268,9.661,-13.578,7.095,12.804,-11.389,6.176,14.601,12.172,7.094,12.81,11.85,6.612,9.492,7.096,3.896,8.887,8.669,4.569,13.119,8.572,5.579,9.666,-11.416,7.027,10.152,-12.051,7.09,12.838,-9.78,6.192,12.687,-7.905,5.731,10.699,7.962,5.737,10.715,-7.253,4.194,9.374,-8.458,4.567,13.306,9.907,6.242,12.642,-8.442,5.606,9.647,11.481,7.228,10.086,-12.177,8.163,14.565,12.325,8.176,14.478,13.162,6.962,14.07,12.305,8.118,9.571,-7.662,5.882,8.464,7.019,6.395,9.05,8.393,6.56,13.192,21,23,19,12,24,16,20,12,23,4,1,12,3,24,2,12,23,5,4,12,22,24,3,12,9,6,5,12,5,10,9,12,15,22,8,12,15,8,12,12,15,12,14,12,19,17,21,12,23,10,5,12,22,15,24,12,23,21,10,12,15,16,24,12,29,32,39,12,40,70,45,12,33,61,71,12,42,65,41,12,44,43,66,12,34,44,42,12,41,34,42,12,39,32,59,12,59,63,39,12,47,50,31,12,25,38,37,12,25,38,45,12,39,48,47,12,48,39,49,12,38,39,63,12,45,38,63,12,36,51,50,12,32,61,60,12,54,40,55,12,34,53,52,12,56,58,35,12,44,66,64,12,65,44,64,12,71,87,33,12,81,80,79,12,81,79,78,12,31,80,82,12,79,30,78,12,80,81,82,12,28,82,81,12,76,26,27,12,27,90,119,12,85,89,90,12,88,84,91,12,64,66,86,12,65,64,67,12,69,68,74,12,101,90,89,12,91,109,88,12,90,101,119,12,28,93,82,12,70,94,92,12,71,93,77,12,118,27,119,12,76,73,92,12,97,96,104,12,98,99,115,12,108,95,94,12,105,97,104,12,93,100,77,12,94,74,108,12,77,100,101,12,109,106,108,12,109,97,106,12,74,109,108,12,107,110,101,12,102,110,107,12,112,110,102,12,105,103,111,12,110,112,98,12,115,114,101,12,109,75,113,12,95,113,117,12,114,115,116,12,95,96,113,12,93,118,100,12,19,23,1,12,2,24,20,12,4,5,6,12,7,22,3,12,8,22,7,12,10,11,9,12,10,13,11,12,14,16,15,12,44,35,43,12,20,16,18,12,29,47,31,12,30,49,70,12,32,71,61,12,41,69,40,12,66,43,33,12,44,65,42,12,35,33,43,12,41,54,53,12,41,53,34,12,61,33,62,12,59,44,63,12,45,63,40,12,44,34,57,12,49,36,48,12,63,44,57,12,50,46,31,12,46,36,30,12,50,48,36,12,86,33,87,12,25,39,38,12,45,39,25,12,49,39,45,12,29,39,47,12,49,45,70,12,46,50,51,12,51,36,46,12,59,32,60,12,55,40,63,12,35,58,62,12,67,41,65,12,80,46,79,12,69,41,68,12,70,40,69,12,79,46,30,12,28,78,92,12,29,31,82,12,78,30,70,12,29,71,32,12,118,28,73,12,92,73,28,12,83,72,85,12,74,70,69,12,27,118,73,12,76,27,73,12,89,86,87,12,26,84,72,12,26,83,27,12,76,75,91,12,27,83,90,12,91,26,76,12,83,85,90,12,91,84,26,12,88,67,84,12,72,86,85,12,72,67,64,12,89,77,101,12,71,77,87,12,68,109,74,12,93,29,82,12,91,75,109,12,92,78,70,12,70,74,94,12,92,75,76,12,95,104,96,12,92,94,117,12,28,118,93,12,102,99,112,12,115,110,98,12,108,103,95,12,98,112,99,12,118,99,100,12,107,100,102,12,111,108,106,12,101,100,107,12,13,21,17,12,106,97,105,12,103,108,111,12,111,106,105,12,105,104,103,12,119,116,118,12,117,94,95,12,99,116,115,12,96,97,113,12,97,109,113,12,101,114,119,12,117,113,75,12,14,18,16,12,44,56,35,12,35,62,33,12,41,40,54,12,59,56,44,12,49,30,36,12,50,47,48,12,86,66,33,12,67,68,41,12,80,31,46,12,28,81,78,12,83,26,72,12,89,85,86,12,88,68,67,12,72,64,86,12,72,84,67,12,89,87,77,12,68,88,109,12,93,71,29,12,92,117,75,12,95,103,104,12,102,100,99,12,115,101,110,12,118,116,99,12,13,10,21,12,119,114,116,12,0.743,-0.656,-0.133,-0.742,-0.657,-0.131,0.466,-0.536,-0.704,-0.466,-0.536,-0.704,-0.15,-0.729,-0.668,0.147,-0.729,-0.669,-0.656,-0.655,-0.374,-0.583,-0.791,0.187,0.588,-0.788,0.184,0.621,-0.706,0.341,0.225,-0.57,0.79,0.781,-0.541,0.313,0.085,-0.996,-0.003,-0.088,-0.996,-0.001,0.234,-0.97,0.072,-0.231,-0.97,0.073,0.242,-0.305,-0.921,-0.288,-0.444,-0.848,0.544,-0.653,-0.527,-0.51,-0.548,0.664,-0.693,-0.449,0.563,-0.2,-0.924,-0.325,-0.202,-0.924,-0.325,0.449,-0.891,-0.07,-0.007,-0.983,0.184,0.406,-0.908,-0.103,-1.0,-0.0,0.0,0.478,-0.572,0.667,0.276,-0.909,-0.313,-0.132,-0.98,-0.147,-0.496,-0.752,-0.433,0.515,-0.766,0.384,0.044,-0.537,-0.843,0.408,-0.853,-0.325,-0.464,-0.854,-0.236,-0.02,0.759,0.651,-0.533,-0.762,0.369,-0.807,-0.178,0.562,0.811,-0.193,0.552,0.958,0.251,0.136,0.026,0.976,-0.218,-0.191,0.978,-0.081,0.964,0.19,0.187,-0.92,0.383,0.082,0.05,0.978,-0.2,0.434,0.064,-0.899,-0.258,0.845,0.469,0.59,0.76,0.274,0.721,-0.057,0.691,-0.728,-0.054,0.683,-0.373,0.815,0.443,0.377,0.814,0.442,-0.944,0.161,0.288,0.949,-0.011,0.315,-0.955,-0.013,0.296,0.961,0.124,0.246,0.543,0.065,-0.838,-0.157,0.035,-0.987,0.373,-0.248,-0.894,0.563,0.797,-0.219,-0.521,0.77,-0.368,0.007,-0.887,-0.463,-0.336,-0.927,0.167,-0.501,-0.828,-0.254,-0.367,-0.875,-0.316,0.288,-0.322,-0.902,-0.737,0.001,-0.676,0.917,0.16,-0.366,-0.947,-0.165,-0.274,-0.573,-0.696,-0.432,-0.945,0.128,-0.301,0.634,-0.606,-0.481,0.068,-0.98,0.188,0.496,-0.868,-0.029,-0.433,-0.901,-0.017,0.358,-0.924,-0.136,-0.022,-0.332,0.943,0.346,0.029,0.938,0.228,0.955,-0.188,0.822,0.57,-0.01,-0.496,0.859,-0.126,0.377,0.072,-0.923,0.753,-0.579,-0.312,-0.754,-0.579,-0.312,-0.256,-0.685,-0.682,0.257,-0.683,-0.684,0.659,-0.653,-0.373,-0.616,-0.71,0.342,-0.225,-0.569,0.791,-0.351,-0.652,0.672,0.291,-0.874,-0.389,-0.781,-0.541,0.313,0.889,-0.42,0.181,-0.894,-0.408,0.188,0.68,-0.695,-0.234,-0.786,-0.423,-0.45,0.521,-0.519,0.677,0.71,-0.435,0.554,0.15,-0.886,-0.438,-0.153,-0.988,0.008,-0.213,-0.959,-0.188,0.133,-0.986,0.097,-0.006,-0.975,-0.222,-0.393,-0.918,-0.06,-0.187,-0.971,-0.147,-0.07,-0.996,-0.06,-0.243,-0.97,-0.008,0.254,-0.9,-0.353,-0.3,-0.893,-0.334,0.152,-0.984,-0.092,0.383,0.095,0.919,-0.494,-0.566,0.66,0.073,0.997,0.031,-0.084,-0.969,-0.234,0.889,-0.42,0.182,-0.9,-0.407,0.158,-0.433,-0.854,0.288,0.912,0.289,0.291,0.037,-0.783,-0.621,0.027,-0.715,-0.699,0.572,-0.638,0.516,-0.483,0.397,0.78,0.062,-0.042,-0.997,-0.931,0.287,0.224,-0.445,0.457,-0.77,-0.017,-0.112,-0.994,-0.304,0.217,-0.928,0.958,0.237,0.16,-0.948,0.289,0.132,0.277,0.598,-0.752,0.404,0.688,-0.603,-0.24,0.523,-0.818,0.155,0.066,0.986,-0.56,-0.332,-0.759,0.472,0.815,-0.337,-0.284,0.953,-0.105,0.618,-0.593,0.516,-0.157,0.021,0.987,0.197,0.708,0.678,-0.671,0.697,0.252,0.478,0.719,0.504,-0.47,0.699,0.539,0.613,0.064,0.788,-0.5,0.186,0.846,-0.615,-0.592,0.521,0.167,-0.75,0.64,-0.133,-0.77,0.624,0.976,-0.196,0.094,0.966,-0.059,0.253,-0.959,-0.259,0.117,0.813,-0.343,-0.47,-0.968,0.112,0.225,-0.956,-0.154,-0.251,-0.517,-0.212,-0.829,-0.579,0.731,-0.361,-0.002,-0.998,-0.056,-0.093,-0.008,-0.996,0.492,-0.032,-0.87,0.23,-0.6,0.766,0.351,-0.861,-0.367,-0.411,-0.748,0.521,-0.769,-0.618,0.164,0.088,0.068,-0.994,0.567,-0.699,0.436,-0.656,-0.633,0.411,0.937,-0.113,-0.33,0.395,-0.624,0.674,-0.727,-0.308,-0.614,0.128,-0.084,0.988,-0.077,-0.985,0.156,-0.37,-0.927,-0.066,-0.315,0.947,0.067,-0.276,-0.137,-0.951,0.931,-0.268,-0.246,-0.675,-0.255,0.692,0.489,0.209,0.847,-0.282,-0.074,0.956,0.361,0.929,-0.08,-0.395,-0.623,0.675,0.208,-0.974,-0.088,0.217,-0.968,-0.128,-0.325,-0.904,-0.278,0.241,-0.97,0.014,-0.433,-0.896,-0.098,0.14,-0.986,-0.095,0.476,0.401,0.783,-0.396,0.096,0.913,-0.027,0.071,-0.997,-0.392,0.259,-0.883,0.117,0.096,0.988,0.624,-0.597,0.503,-0.638,-0.605,0.476,0.136,-0.771,0.623,-0.201,-0.721,0.663,0.923,-0.366,0.118,-0.961,-0.273,-0.054,0.495,-0.176,-0.851,-0.386,0.906,-0.172,-0.21,-0.977,-0.027,0.219,-0.562,0.798,0.436,-0.53,-0.727,0.09,0.025,-0.996,0.361,-0.647,0.672,-0.377,0.926,-0.01,")
    local pyramid1 = get_asset(g_asset_library, "pyramid").model
    pyramid1.loc = { x = 0, y = 30, z = 0 }
    pyramid1.rot = { x = 0, y =  0, z = 0 }

    local pyramid2 = get_asset(g_asset_library, "pyramid").model
    pyramid2.loc = { x = 10, y = 45, z = 0 }
    pyramid2.rot = { x =  0, y =  0, z = 0 }

    local cube = get_asset(g_asset_library, "BMesh").model
    cube.loc = { x = 20, y = 30, z = 0 }
    cube.rot = { x =  0, y =  0, z = 0 }

    g_models = { pyramid1, pyramid2, cube }

    g_camera = {
        loc = { x = 0, y = -15, z =  15 },
        rot = { x = 0, y =   0, z = .05 },
        fov = 60 / 360,
        near = 1,
        far = 100
    }
end

function _update60()
    g_models[1].rot.z = (g_models[1].rot.z + 0.005) % 1
    g_models[3].rot.z = (g_models[3].rot.z + 0.0025) % 1

    local move_vector = { x = 0, y = 0, z = 0 }

    rot_speed = .005
    movespeed = .2

    if btn(0) then
        g_camera.rot.z = (g_camera.rot.z - rot_speed % 1)
    end
    if btn(1) then
        g_camera.rot.z = (g_camera.rot.z + rot_speed % 1)
    end
    if btn(2) then
        move_vector.y = movespeed
    end
    if btn(3) then
        move_vector.y = movespeed * -1
    end
    if btn(4) then
        move_vector.x = movespeed * -1
    end
    if btn(5) then
        move_vector.x = movespeed
    end

    local view_rot = make_rotation_matrix({ x = 0, y = 0, z = g_camera.rot.z * -1 })
    g_camera.loc = add_v_v(g_camera.loc, mult_v_44(move_vector, view_rot))

    if btnp(5, 1) then
        g_wireframe = not g_wireframe
        g_filled = not g_filled
    end
end

function _draw()
    cls()
    draw3d()
end

-->8
--3D projection and drawing
function vetex_visible(vertex, cam)
    return vertex.z > cam.near and vertex.z < cam.far
end

function make_rotation_matrix(rotation)
    local xrot = {
        { 1,               0,                    0, 0 },
        { 0, cos(rotation.x), -1 * sin(rotation.x), 0 },
        { 0, sin(rotation.x),      cos(rotation.x), 0 },
        { 0,               0,                    0, 1 }
    }
    local yrot = {
        {      cos(rotation.y), 0, sin(rotation.y), 0 },
        {                    0, 1,               0, 0 },
        { -1 * sin(rotation.y), 0, cos(rotation.y), 0 },
        {                    0, 0,               0, 1 }
    }
    local zrot = {
        { cos(rotation.z), -1 * sin(rotation.z), 0, 0 },
        { sin(rotation.z),      cos(rotation.z), 0, 0 },
        {               0,                    0, 1, 0 },
        {               0,                    0, 0, 1 }
    }

    local rotationmat = mult_mat(xrot, yrot)
    rotationmat = mult_mat(rotationmat, zrot)

    return rotationmat
end

function project(camera, models, emit_triangle)
    local tanfov = abs(tan(camera.fov / 2))
    local nearplanew = tanfov * camera.near
    local farplanew = tanfov * camera.far
    local perspectivesf = (farplanew - nearplanew) / (camera.far - camera.near)
    local camerarot = make_rotation_matrix(camera.rot)
    local half_width = c_screen_width / 2
    local half_height = c_screen_height / 2
    local pixel_scale = c_screen_width / (nearplanew * 2)

    camera_trans = {
        x = camera.loc.x * -1,
        y = camera.loc.y * -1,
        z = camera.loc.z * -1,
    }

    for mi, model in pairs(models) do
        local projected_vertices = { }

        local modelrot = make_rotation_matrix(model.rot)
        local modelloc = add_v_v(camera_trans, model.loc)

        for vi, vert in pairs(model.vertices) do
            -- rotate relative to model center
            local vertex = mult_v_44(vert, modelrot)

            -- translate relative to camera
            vertex = add_v_v(modelloc, vertex)

            -- rotate relative to camera
            vertex = mult_v_44(vertex, camerarot)

            -- perspective scaling
            local scalefactor = vertex.y * perspectivesf
            vertex.x /= scalefactor
            vertex.z /= scalefactor

            -- flip z and y for convenience later
            local z = vertex.z
            vertex.z = vertex.y
            vertex.y = z

            projected_vertices[vi] = vertex
        end

        local facei = 1
        for fi, face in pairs(model.faces) do
            local v1 = projected_vertices[face[1]]
            local v2 = projected_vertices[face[2]]
            local v3 = projected_vertices[face[3]]

            -- note:: normals here are not really correct.
            -- they are just being rotated with the rest of the model.
            -- this does not take into account any perspective skewing
            -- or, in the future, vertex transformations. this should
            -- be good enough for back-face culling, though. the main
            -- problem it has is flat planes facing cardinal directions.

            local normal = mult_v_44(model.normals[fi], modelrot)
            normal = mult_v_44(normal, camerarot)

            if (vetex_visible(v1, camera) or vetex_visible(v2, camera) or vetex_visible(v3, camera)) then
                local midx = (v1.x + v2.x + v3.x) / 3
                local midy = (v1.y + v2.y + v3.y) / 3
                local midz = (v1.z + v2.z + v3.z) / 3

                local screen_v1_x = (v1.x * pixel_scale) + half_width
                local screen_v2_x = (v2.x * pixel_scale) + half_width
                local screen_v3_x = (v3.x * pixel_scale) + half_width

                local screen_v1_y = c_screen_height - ((v1.y * pixel_scale) + half_height)
                local screen_v2_y = c_screen_height - ((v2.y * pixel_scale) + half_height)
                local screen_v3_y = c_screen_height - ((v3.y * pixel_scale) + half_height)

                emit_triangle({
                    color = face[4],
                    distance = (midx * midx) + (midy * midy) + (midz * midz),
                    v1 = { x = screen_v1_x, y = screen_v1_y, z = v1.z },
                    v2 = { x = screen_v2_x, y = screen_v2_y, z = v2.z },
                    v3 = { x = screen_v3_x, y = screen_v3_y, z = v3.z }
                })
            end
        end
    end
end

function draw_wire_polygon(col, v1, v2, v3)
    line(v1.x, v1.y, v2.x, v2.y, col)
    line(v2.x, v2.y, v3.x, v3.y, col)
    line(v3.x, v3.y, v1.x, v1.y, col)
end

function draw_span(mainx, offx, row, minx, maxx, color)
    if offx < mainx then
        -- "main" and "off" lose their meaning here if we
        -- need to swap. oh, well.
        local temp = offx
        offx = mainx
        mainx = temp
    end

    local left = mainx > minx and mainx or minx
    left = left >= 0 and left or 0

    local right = offx < maxx and offx or maxx
    right = right < c_screen_width and right or c_screen_width

    for x = flr(left), flr(right) do
        pset(x, row, color)
    end
end

function draw_spans(mainx, offx, starty, endy, mainstepx, offstepx, color, minx, maxx, drawbottom)
    assert(endy >= starty)
    starty = flr(starty)
    endy = flr(endy)
    if not drawbottom then endy -= 1 end
    if endy < starty then endy = starty end

    for row = starty, endy do
        if row >= c_screen_height then
            break
        end
        if row >= 0 then
            draw_span(mainx, offx, row, minx, maxx, color)
        end
        mainx += mainstepx
        offx += offstepx
    end

    return mainx
end

function draw_triangle(color, v1, v2, v3)
    -- find the topmost vertex. "topmost" means highest y in clip space.
    local topmost = v1.y < v2.y and v1 or v2
    topmost = topmost.y < v3.y and topmost or v3

    -- find the bottommost vertex. "bottommost" means lowest y in clip space.
    local bottommost = v1.y > v2.y and v1 or v2
    bottommost = bottommost.y > v3.y and bottommost or v3

    if topmost.y == bottommost.y then
        -- todo: it's a horizontal line
        return
    end

    -- "midpoint" is a slight misnomer, as it is not centered and may even be
    -- level with the top or bottom points.
    local midpoint = v1
    if midpoint == topmost or midpoint == bottommost then
        midpoint = v2
    end
    if midpoint == topmost or midpoint == bottommost then
        midpoint = v3
    end

    -- traverse from topmost to bottommost
    -- "main" in this context means, "along or related to the edge with the biggest range."
    -- "off" in the context means, "along the edge from a main vertex to the mid vertex."
    local mainstepx = (bottommost.x - topmost.x) / (bottommost.y - topmost.y)
    local mainx = topmost.x

    local has_top = flr(midpoint.y) > flr(topmost.y)
    local has_bottom = flr(bottommost.y) > flr(midpoint.y)

    local minx = v1.x < v2.x and v1.x or v2.x
    minx = minx < v3.x and minx or v3.x


    local maxx = v1.x > v2.x and v1.x or v2.x
    maxx = maxx > v3.x and maxx or v3.x

    -- "midpoint" may actually be at our same y. if it is, skip the top "half"
    if has_top then
        local offstepx = (midpoint.x - topmost.x) / (midpoint.y - topmost.y)
        local offx = topmost.x
        mainx = draw_spans(mainx, offx, topmost.y, midpoint.y, mainstepx, offstepx, color, minx, maxx, not has_bottom)
    end

    -- now draw the bottom "half" if applicable
    if has_bottom then
        local offx = midpoint.x
        local offstepx = (bottommost.x - midpoint.x) / (bottommost.y - midpoint.y)
        draw_spans(mainx, offx, midpoint.y, bottommost.y, mainstepx, offstepx, color, minx, maxx, true)
    end
end

function draw3d()
    local head_node = nil
    project(g_camera, g_models, function(triangle)
        local node = {
            triangle = triangle,
            left = nil,
            right = nil
        }

        if head_node == nil then
            head_node = node
        else
            insert_node(head_node,node)
        end
    end)

    if g_filled then
        traverse(head_node, function(triangle)
            draw_triangle(triangle.color, triangle.v1, triangle.v2, triangle.v3)
        end)
    end

    if g_wireframe then
        traverse(head_node, function(triangle)
            draw_wire_polygon(triangle.color, triangle.v1, triangle.v2, triangle.v3)
        end)
    end
end

-->8
-- math and algorithem support

-- multiplies a vertx by a 4x4 matrix,
-- assumes vertex is homogeneous with a
-- w-value of 1
function mult_v_44(vertex, m44)
    local new_vertex = {
        x = (vertex.x * m44[1][1]) + (vertex.y * m44[2][1]) + (vertex.z * m44[3][1]) + m44[4][1],
        y = (vertex.x * m44[1][2]) + (vertex.y * m44[2][2]) + (vertex.z * m44[3][2]) + m44[4][2],
        z = (vertex.x * m44[1][3]) + (vertex.y * m44[2][3]) + (vertex.z * m44[3][3]) + m44[4][3],
    }

    local w = (vertex.x * m44[1][4]) + (vertex.y * m44[2][4]) + (vertex.z * m44[3][4]) + m44[4][4]

    if w != 1 and w != 0 then
       mat.x /= w
       mat.y /= w
       mat.z /= w
    end

    return new_vertex
end

function add_v_v(v1, v2)
    return {
        x = v1.x + v2.x,
        y = v1.y + v2.y,
        z = v1.z + v2.z
    }
end

function sub_v_v(v1, v2)
    return {
        x = v1.x - v2.x,
        y = v1.y - v2.y,
        z = v1.z - v2.z
    }
end

-- stole this from rosettacode
function mult_mat(m1, m2)
    if #m1[1] ~= #m2 then
        return nil
    end

    local res = {}

    for i = 1, #m1 do
        res[i] = {}
        for j = 1, #m2[1] do
            res[i][j] = 0
            for k = 1, #m2 do
                res[i][j] = res[i][j] + m1[i][k] * m2[k][j]
            end
        end
    end

    return res
end

-- for some reason, there is no tan() in the
-- standard library. *shrug*
function tan(angle)
    return sin(angle) / cos(angle)
end

function insert_node(head, new)
    local node = head
    repeat
        if new.triangle.distance > node.triangle.distance then
            if node.left == nil then
                node.left = new
                return
            else
                node = node.left
            end
        else
            if node.right == nil then
                node.right = new
                return
            else
                node = node.right
            end
        end
    until false
end

function traverse(node, trifunc)
    if node != nil then
        traverse(node.left, trifunc)
        trifunc(node.triangle)
        traverse(node.right, trifunc)
    end
end

-- stole this from stackoverflow
-- https://stackoverflow.com/questions/640642/how-do-you-copy-a-lua-table-by-value
function copy(obj, seen)
    if type(obj) ~= 'table' then return obj end
    if seen and seen[obj] then return seen[obj] end
    local s = seen or {}
    local res = setmetatable({}, getmetatable(obj))
    s[obj] = res
    for k, v in pairs(obj) do res[copy(k, s)] = copy(v, s) end
    return res
end

-->8
-- asset library parser
-- this is intented to take some dead-simple
-- non-huma-readable serialized models and store
-- them into an "asset library" to be pulled
-- from at runtime.

-- the whole library is given as a comma-separted
-- list. the first value is the name of the asset.
-- after that is the vertex count, then the face
-- count. the parser extpects the next set of
-- values (3 x number of vertices) to be vertex
-- data. It then expects the following set to be
-- face data ((3 + 3 + 1) * number of faces, three
-- indices, a normal vector, and a color).
function parse_asset_library(library)
    local index = 1
    local length = #library

    function next_token(allow_end, num_cast)
        if allow_end == nil then allow_end = false end
        if num_cast == nil then num_cast = true end
        if index > length then
            assert(allow_end, "Unexpected end of library")
            return -1
        end

        local start = index
        local endi = index

        repeat endi += 1
        until sub(library, endi, endi) == "," or endi > length

        -- go past the comma
        index = endi + 1
        -- -1 to go back to the actual index
        local token = sub(library, start, endi-1)
        if num_cast then
            -- make sure we explicitly cast this to a number
            token = token + 0
        end

        return token
    end

    local library = {}
    repeat
        local name = next_token(true, false)
        if name == -1 then
            break
        end

        local asset = {
            name = name,
            model = {
                vertices = {},
                faces = {},
                normals = {},
                loc = { x = 0, y = 0, z = 0 },
                rot = { x = 0, y = 0, z = 0 }
            }
        }

        local verts = next_token()
        local faces = next_token()

        for vert=1, verts do
            add(asset.model.vertices, {
                x = next_token(),
                y = next_token(),
                z = next_token()
            })
        end

        for face=1, faces do
            add(asset.model.faces, {
                next_token(),
                next_token(),
                next_token(),
                next_token()
            })
        end

        for face=1, faces do
            add(asset.model.normals, {
                x = next_token(),
                y = next_token(),
                z = next_token()
            })
        end

        library[name] = asset
    until false

    return library
end

function get_asset(library, name)
    local original = library[name]
    assert(original != nil, "Asset " .. name .. " not found")
    return copy(original)
end

__gfx__
ccc11111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cc177111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c17cc711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17c07c11000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17c0071c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
117771cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344

